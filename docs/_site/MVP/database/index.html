<!DOCTYPE html>

<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Database Modeling | Design Docs</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Database Modeling" />
<meta name="author" content="Leandro Pessini" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="An AWS Aurora MySQL database will be used to store the data after being dumped on AWS S3 Bucket. An entity-relationship (ER) diagram was used as initial schema:" />
<meta property="og:description" content="An AWS Aurora MySQL database will be used to store the data after being dumped on AWS S3 Bucket. An entity-relationship (ER) diagram was used as initial schema:" />
<link rel="canonical" href="http://localhost:4000/moby-bikes/mvp/database/" />
<meta property="og:url" content="http://localhost:4000/moby-bikes/mvp/database/" />
<meta property="og:site_name" content="Design Docs" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Database Modeling" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"Article","author":{"@type":"Person","name":"Leandro Pessini"},"description":"An AWS Aurora MySQL database will be used to store the data after being dumped on AWS S3 Bucket. An entity-relationship (ER) diagram was used as initial schema:","headline":"Database Modeling","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/moby-bikes/siteicon.png"},"name":"Leandro Pessini"},"url":"http://localhost:4000/moby-bikes/mvp/database/"}</script>
<!-- End Jekyll SEO tag -->

		<link type="application/atom+xml" rel="alternate" href="http://localhost:4000/moby-bikes/feed.xml" title="Design Docs" />

		<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,700,700italic|Open+Sans:400,400italic,600,600italic,700,700italic|Inconsolata:400,700">
		<link rel="stylesheet" href="/moby-bikes/css/main.css">
		<link rel="apple-touch-icon" href="/moby-bikes/apple-touch-icon.png">
		<link rel="icon" type="image/png" href="/moby-bikes/touch-icon.png" sizes="192x192">
		<link rel="icon" type="image/png" href="/moby-bikes/images/favicon.png">
		
		<style>
			a.btn {
						color: #fff;
						background-color: #206b82;
						border-color: #1b5a6e;
						display: inline-block;
						margin-bottom: 0;
						touch-action: manipulation;
						cursor: pointer;
						background-image: none;
						border: 1px solid transparent;
						padding: 6px 14px;
						font-size: 13px;
						border-radius: 6px;
						-webkit-user-select: none;
						-moz-user-select: none;
						-ms-user-select: none;
						user-select: none;
					}
				a.btn:hover{
					opacity: 90%;
					text-decoration: none;
					color: #fff;
				}
				a.site-title{
					text-decoration: none;
				}
		</style>
	</head>

	<body>
		<header>
			<a href="/moby-bikes/" class="site-title">
				<h1>
					<img src="/moby-bikes/images/emblem.svg" width="40" height="40" alt="Design Docs logo">Design Docs
					<button type="button" class="open-nav" id="open-nav"></button>
				</h1>
			</a>

			<form action="/moby-bikes/search/" method="get">
				<input type="text" name="q" id="search-input" placeholder="Search" autofocus>
				<input type="submit" value="Search" style="display: none;">
			</form>

			<nav class="full-navigation">
				<ul>
					<li class="nav-item top-level ">
						
						<a href="/moby-bikes/">eBikes Operations Optimization</a>
					</li>
				</ul>

				<ul>
					
					
						<li class="nav-item top-level ">
							
							<a href="/moby-bikes/milestones-results/challenges/">Milestones and Results</a>
							<ul>
								
									
										<li class="nav-item "><a href="/moby-bikes/milestones-results/challenges/">Challenges and directions</a></li>
									
								
									
										<li class="nav-item "><a href="/moby-bikes/milestones-results/feature-engineering/">Feature Engineering</a></li>
									
								
									
										<li class="nav-item "><a href="/moby-bikes/milestones-results/Machine-Learning/">Machine Learning</a></li>
									
								
							</ul>
						</li>
					
						<li class="nav-item top-level current">
							
							<a href="/moby-bikes/mvp/pipeline/">Minimum Viable Product (MVP)</a>
							<ul>
								
									
										<li class="nav-item "><a href="/moby-bikes/mvp/pipeline/">Data Pipeline</a></li>
									
								
									
										<li class="nav-item current"><a href="/moby-bikes/mvp/database/">Database Modeling</a></li>
									
								
									
										<li class="nav-item "><a href="/moby-bikes/mvp/streamlit/">Web App Mockup</a></li>
									
								
							</ul>
						</li>
					
						<li class="nav-item top-level ">
							
							<a href="/moby-bikes/tools-references/">Tools and References</a>
							<ul>
								
									
								
							</ul>
						</li>
					
				</ul>

				<ul>
					<li class="nav-item top-level" style="text-align:center; margin-top:10px">
						<a href="https://pessini-moby-bikes-dashboardapp-hhvohw.streamlitapp.com/" target="_blank" class="btn">
							<svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="currentColor" class="bi bi-box-arrow-up-right" viewBox="0 0 16 16">
							  <path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/>
							  <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/>
							</svg><span style="vertical-align: baseline;">&nbspGo to Web App</span>
						</a>
					</li>
				</ul>
			</nav>
		</header>

		<section class="main">
			<div class="page-header">
				<h2>Minimum Viable Product (MVP)</h2>
				<!-- <h3>Database Modeling</h3> -->

					
					    <h3 style="padding-top: 35px">Database Modeling</h3>
					

			</div>
			<article class="content">
				<p>An AWS Aurora MySQL database will be used to store the data after being dumped on AWS S3 Bucket. An <a href="https://www.quickdatabasediagrams.com/">entity-relationship (ER) diagram</a> was used as initial schema:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="/moby-bikes/images/DBDataModel.png" alt="Database Model" /></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><em>Entity-Relationship (ER) Diagram</em></td>
    </tr>
  </tbody>
</table>

<p>See online: <a href="https://app.quickdatabasediagrams.com/#/d/fWEwXP">https://app.quickdatabasediagrams.com/#/d/fWEwXP</a></p>

<h2 id="business-rules---mysql">Business Rules - MySQL</h2>

<p>A set of functions and stored procedures were created to handle processing and logging with SQL.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- --------------------------------------------------------------------------------------------------</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">mobybikes</span><span class="p">.</span><span class="n">TEMP_completed_rentals</span><span class="p">;</span>
<span class="c1">-- DROP TEMPORARY TABLE IF EXISTS completed_rentals;</span>

<span class="c1">-- --------------------------------------------------------------------------------------------------</span>
<span class="c1">-- Function to calculate rentals duration</span>
<span class="cm">/**
	Assumption: Due to lack of information and data, to calculate the duration rental time I am assuming that when a new
    bike rental starts the duration in *minutes* will be calculated by: RentalDuration = LastGPSTime - LastRentalStart
*/</span>
<span class="c1">-- --------------------------------------------------------------------------------------------------</span>
<span class="n">USE</span> <span class="n">mobybikes</span><span class="p">;</span>

<span class="k">DROP</span> <span class="k">FUNCTION</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">FN_RENTAL_DURATION</span><span class="p">;</span>
<span class="k">DELIMITER</span> <span class="o">//</span>
<span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">FN_RENTAL_DURATION</span><span class="p">(</span><span class="n">LAST_GPSTIME</span> <span class="nb">DATETIME</span><span class="p">,</span> <span class="n">RENTAL_START</span> <span class="nb">DATETIME</span><span class="p">)</span>
<span class="k">RETURNS</span> <span class="nb">INT</span>
<span class="k">DETERMINISTIC</span>
<span class="k">BEGIN</span>
	<span class="k">DECLARE</span> <span class="n">duration</span> <span class="nb">BIGINT</span> <span class="k">DEFAULT</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">SET</span> <span class="n">duration</span> <span class="o">=</span> <span class="n">TIMESTAMPDIFF</span><span class="p">(</span><span class="k">MINUTE</span><span class="p">,</span> <span class="n">RENTAL_START</span><span class="p">,</span> <span class="n">LAST_GPSTIME</span><span class="p">);</span>

    <span class="n">IF</span> <span class="n">duration</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">THEN</span>
		<span class="k">SET</span> <span class="n">duration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">END</span> <span class="n">IF</span><span class="p">;</span>

    <span class="k">RETURN</span> <span class="n">duration</span><span class="p">;</span>
<span class="k">END</span> <span class="o">//</span>
<span class="k">DELIMITER</span> <span class="p">;</span>

<span class="k">DROP</span> <span class="k">FUNCTION</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">FN_TIMESOFDAY</span><span class="p">;</span>
<span class="k">DELIMITER</span> <span class="o">//</span>
<span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">FN_TIMESOFDAY</span><span class="p">(</span><span class="n">rental_date</span> <span class="nb">DATETIME</span><span class="p">)</span>
<span class="k">RETURNS</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="k">DETERMINISTIC</span>
<span class="k">BEGIN</span>
	<span class="k">DECLARE</span> <span class="n">timeofday</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
  <span class="k">DECLARE</span> <span class="n">rental_hour</span> <span class="nb">INT</span><span class="p">;</span>

  <span class="k">SET</span> <span class="n">rental_hour</span> <span class="p">:</span><span class="o">=</span> <span class="n">HOUR</span><span class="p">(</span><span class="n">rental_date</span><span class="p">);</span>

  <span class="n">IF</span> <span class="n">rental_hour</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="k">THEN</span>
		<span class="k">SET</span> <span class="n">timeofday</span> <span class="p">:</span><span class="o">=</span> <span class="s1">'Night'</span><span class="p">;</span>
	<span class="n">ELSEIF</span> <span class="n">rental_hour</span> <span class="o">&gt;=</span> <span class="mi">7</span> <span class="k">AND</span> <span class="n">rental_hour</span> <span class="o">&lt;</span> <span class="mi">12</span> <span class="k">THEN</span>
		<span class="k">SET</span> <span class="n">timeofday</span> <span class="p">:</span><span class="o">=</span> <span class="s1">'Morning'</span><span class="p">;</span>
	<span class="n">ELSEIF</span> <span class="n">rental_hour</span> <span class="o">&gt;=</span> <span class="mi">12</span> <span class="k">AND</span> <span class="n">rental_hour</span> <span class="o">&lt;</span> <span class="mi">18</span> <span class="k">THEN</span>
		<span class="k">SET</span> <span class="n">timeofday</span> <span class="p">:</span><span class="o">=</span> <span class="s1">'Afternoon'</span><span class="p">;</span>
	<span class="n">ELSEIF</span> <span class="n">rental_hour</span> <span class="o">&gt;=</span> <span class="mi">18</span> <span class="k">AND</span> <span class="n">rental_hour</span> <span class="o">&lt;</span> <span class="mi">23</span> <span class="k">THEN</span>
		<span class="k">SET</span> <span class="n">timeofday</span> <span class="p">:</span><span class="o">=</span> <span class="s1">'Evening'</span><span class="p">;</span>
	<span class="k">ELSE</span>
		<span class="k">SET</span> <span class="n">timeofday</span> <span class="p">:</span><span class="o">=</span> <span class="s1">'Night'</span><span class="p">;</span>
	 <span class="k">END</span> <span class="n">IF</span><span class="p">;</span>

  <span class="k">RETURN</span> <span class="n">timeofday</span><span class="p">;</span>
<span class="k">END</span> <span class="o">//</span>
<span class="k">DELIMITER</span> <span class="p">;</span>

<span class="k">DROP</span> <span class="k">PROCEDURE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">SP_LOG_RENTAL_EVENTS</span><span class="p">;</span>
<span class="k">DELIMITER</span> <span class="o">//</span>
<span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="n">SP_LOG_RENTAL_EVENTS</span><span class="p">(</span>
    <span class="k">IN</span> <span class="n">rentals_processed</span> <span class="nb">INT</span><span class="p">,</span>
    <span class="k">IN</span> <span class="n">number_errors</span> <span class="nb">INT</span>
<span class="p">)</span>
<span class="k">BEGIN</span>

	<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">mobybikes</span><span class="p">.</span><span class="n">Log_Rentals</span> <span class="p">(</span><span class="nv">`Date`</span><span class="p">,</span> <span class="nv">`Processed`</span><span class="p">,</span> <span class="nv">`Errors`</span><span class="p">)</span>
    <span class="k">VALUES</span> <span class="p">(</span><span class="n">NOW</span><span class="p">(),</span> <span class="n">rentals_processed</span><span class="p">,</span> <span class="n">number_errors</span><span class="p">);</span>

<span class="k">END</span> <span class="o">//</span>
<span class="k">DELIMITER</span> <span class="p">;</span>

<span class="k">DROP</span> <span class="k">PROCEDURE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">SP_GET_TOTAL_RENTALS_TO_PROCESS</span><span class="p">;</span>
<span class="k">DELIMITER</span> <span class="o">//</span>
<span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="n">SP_GET_TOTAL_RENTALS_TO_PROCESS</span><span class="p">(</span><span class="k">OUT</span> <span class="n">total_rentals</span> <span class="nb">INT</span><span class="p">)</span>
<span class="k">BEGIN</span>

	<span class="k">SELECT</span>
		<span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">INTO</span> <span class="n">total_rentals</span>
	<span class="k">FROM</span>
    <span class="p">(</span>
		<span class="k">SELECT</span>
			<span class="n">LastRentalStart</span><span class="p">,</span>
			<span class="n">BikeID</span>
		<span class="k">FROM</span>
			<span class="n">mobybikes</span><span class="p">.</span><span class="n">rawRentals</span>
		<span class="k">GROUP</span> <span class="k">BY</span>
			<span class="n">LastRentalStart</span><span class="p">,</span> <span class="n">BikeID</span>
	<span class="p">)</span> <span class="k">AS</span> <span class="n">r</span><span class="p">;</span>

<span class="k">END</span> <span class="o">//</span>
<span class="k">DELIMITER</span> <span class="p">;</span>

<span class="k">DROP</span> <span class="k">PROCEDURE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">SP_GET_TOTAL_OPENED_RENTALS</span><span class="p">;</span>
<span class="k">DELIMITER</span> <span class="o">//</span>
<span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="n">SP_GET_TOTAL_OPENED_RENTALS</span><span class="p">(</span><span class="k">OUT</span> <span class="n">opened_rentals</span> <span class="nb">INT</span><span class="p">)</span>
<span class="k">BEGIN</span>
    <span class="k">WITH</span> <span class="n">CTE_OPENED_RENTALS</span> <span class="k">AS</span> <span class="p">(</span>
		<span class="k">SELECT</span>
			<span class="n">r</span><span class="p">.</span><span class="n">LastRentalStart</span><span class="p">,</span>
			<span class="n">r</span><span class="p">.</span><span class="n">BikeID</span><span class="p">,</span>
			<span class="n">r</span><span class="p">.</span><span class="n">rent_rank</span>
		<span class="k">FROM</span>
		<span class="p">(</span>
			<span class="k">SELECT</span>
				<span class="n">LastRentalStart</span><span class="p">,</span>
				<span class="n">BikeID</span><span class="p">,</span>
				<span class="n">RANK</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">BikeID</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">LastRentalStart</span> <span class="k">DESC</span><span class="p">)</span> <span class="n">rent_rank</span>
			<span class="k">FROM</span>
				<span class="n">mobybikes</span><span class="p">.</span><span class="n">rawRentals</span>
			<span class="k">GROUP</span> <span class="k">BY</span>
				<span class="n">LastRentalStart</span><span class="p">,</span> <span class="n">BikeID</span>
		<span class="p">)</span> <span class="n">r</span>
        <span class="k">WHERE</span> <span class="n">rent_rank</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="p">)</span>
    <span class="c1">-- returning the number of rentals NOT completed</span>
	<span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">INTO</span> <span class="n">opened_rentals</span> <span class="k">FROM</span> <span class="n">CTE_OPENED_RENTALS</span><span class="p">;</span>

<span class="k">END</span> <span class="o">//</span>
<span class="k">DELIMITER</span> <span class="p">;</span>

<span class="k">DROP</span> <span class="k">PROCEDURE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">SP_COMPLETED_RENTALS</span><span class="p">;</span>
<span class="k">DELIMITER</span> <span class="o">//</span>
<span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="n">SP_COMPLETED_RENTALS</span><span class="p">(</span><span class="k">OUT</span> <span class="n">rentals_to_process</span> <span class="nb">INT</span><span class="p">)</span>
<span class="k">BEGIN</span>
	<span class="c1">-- The ERROR 1137 is a known issue with MySQL that hasnâ€™t got any fix since 2008.</span>
	<span class="c1">-- Not creating a temporary table because of an issue referenced above.</span>

  <span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">TEMP_completed_rentals</span><span class="p">;</span>

	<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">TEMP_completed_rentals</span>
	<span class="k">SELECT</span>
		<span class="n">r</span><span class="p">.</span><span class="n">LastRentalStart</span><span class="p">,</span>
		<span class="n">r</span><span class="p">.</span><span class="n">BikeID</span><span class="p">,</span>
		<span class="n">r</span><span class="p">.</span><span class="n">rent_rank</span>
	<span class="k">FROM</span>
	<span class="p">(</span>
		<span class="k">SELECT</span>
			<span class="n">LastRentalStart</span><span class="p">,</span>
			<span class="n">BikeID</span><span class="p">,</span>
			<span class="n">RANK</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">BikeID</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">LastRentalStart</span> <span class="k">DESC</span><span class="p">)</span> <span class="n">rent_rank</span>
		<span class="k">FROM</span>
			<span class="n">mobybikes</span><span class="p">.</span><span class="n">rawRentals</span>
		<span class="k">GROUP</span> <span class="k">BY</span>
			<span class="n">LastRentalStart</span><span class="p">,</span> <span class="n">BikeID</span>
	<span class="p">)</span> <span class="n">r</span>
	<span class="k">WHERE</span> <span class="n">rent_rank</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">;</span>

    <span class="c1">-- returning the number of rentals to be processed</span>
	<span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">INTO</span> <span class="n">rentals_to_process</span> <span class="k">FROM</span> <span class="n">TEMP_completed_rentals</span><span class="p">;</span>

<span class="k">END</span> <span class="o">//</span>
<span class="k">DELIMITER</span> <span class="p">;</span>

<span class="k">DROP</span> <span class="k">PROCEDURE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">SP_CLEASING_PROCESSED_RENTALS</span><span class="p">;</span>
<span class="k">DELIMITER</span> <span class="o">//</span>
<span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="n">SP_CLEASING_PROCESSED_RENTALS</span><span class="p">()</span>
<span class="k">BEGIN</span>
	<span class="k">SET</span> <span class="n">SQL_SAFE_UPDATES</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">mobybikes</span><span class="p">.</span><span class="n">rawRentals</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">LastRentalStart</span><span class="p">,</span><span class="n">BikeID</span><span class="p">)</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">LastRentalStart</span><span class="p">,</span><span class="n">BikeID</span> <span class="k">FROM</span> <span class="n">mobybikes</span><span class="p">.</span><span class="n">TEMP_completed_rentals</span><span class="p">);</span>
    <span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">TEMP_completed_rentals</span><span class="p">;</span>
    <span class="k">SET</span> <span class="n">SQL_SAFE_UPDATES</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">END</span> <span class="o">//</span>
<span class="k">DELIMITER</span> <span class="p">;</span>

<span class="k">DROP</span> <span class="k">PROCEDURE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">SP_COORDINATES</span><span class="p">;</span>
<span class="k">DELIMITER</span> <span class="o">//</span>
<span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="n">SP_COORDINATES</span><span class="p">()</span>
<span class="k">BEGIN</span>

	<span class="k">INSERT</span> <span class="k">IGNORE</span> <span class="k">INTO</span> <span class="n">mobybikes</span><span class="p">.</span><span class="n">Rentals_Coordinates</span> <span class="p">(</span><span class="nv">`Date`</span><span class="p">,</span> <span class="n">BikeID</span><span class="p">,</span> <span class="n">Latitude</span><span class="p">,</span> <span class="n">Longitude</span><span class="p">)</span>
    <span class="k">SELECT</span>
		<span class="n">LastRentalStart</span><span class="p">,</span>
        <span class="n">BikeID</span><span class="p">,</span>
        <span class="n">Latitude</span><span class="p">,</span>
        <span class="n">Longitude</span>
	<span class="k">FROM</span>
		<span class="n">mobybikes</span><span class="p">.</span><span class="n">rawRentals</span>
	<span class="k">WHERE</span>
		<span class="p">(</span><span class="n">LastRentalStart</span><span class="p">,</span><span class="n">BikeID</span><span class="p">)</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">LastRentalStart</span><span class="p">,</span><span class="n">BikeID</span> <span class="k">FROM</span> <span class="n">mobybikes</span><span class="p">.</span><span class="n">TEMP_completed_rentals</span><span class="p">)</span>
	<span class="k">AND</span>
		<span class="p">(</span><span class="n">Latitude</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">OR</span> <span class="n">Longitude</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">)</span>
	<span class="k">AND</span>
		<span class="p">(</span><span class="n">Latitude</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="k">OR</span> <span class="n">Longitude</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">END</span> <span class="o">//</span>
<span class="k">DELIMITER</span> <span class="p">;</span>

<span class="k">DROP</span> <span class="k">PROCEDURE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">SP_RENTALS_PROCESSING</span><span class="p">;</span>
<span class="k">DELIMITER</span> <span class="o">//</span>
<span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="n">SP_RENTALS_PROCESSING</span><span class="p">()</span>
<span class="k">BEGIN</span>

  <span class="k">DECLARE</span> <span class="n">total_completed_rentals</span><span class="p">,</span> <span class="n">total_opened_rentals</span><span class="p">,</span> <span class="n">rentals_to_process</span><span class="p">,</span> <span class="n">number_errors</span> <span class="nb">INT</span><span class="p">;</span>

	<span class="c1">-- creates a temporary table and returns the total of completed rentals</span>
	<span class="k">CALL</span> <span class="n">SP_COMPLETED_RENTALS</span><span class="p">(</span><span class="n">total_completed_rentals</span><span class="p">);</span>

	<span class="k">INSERT</span> <span class="k">IGNORE</span> <span class="k">INTO</span> <span class="n">mobybikes</span><span class="p">.</span><span class="n">Rentals</span> <span class="p">(</span><span class="nb">Date</span><span class="p">,</span> <span class="n">BikeID</span><span class="p">,</span> <span class="n">BatteryStart</span><span class="p">,</span> <span class="n">BatteryEnd</span><span class="p">,</span> <span class="n">Duration</span><span class="p">)</span>
	<span class="k">WITH</span> <span class="n">CTE_RENTAL_START_FINISH</span> <span class="k">AS</span> <span class="p">(</span>
		<span class="k">SELECT</span>
			<span class="n">t</span><span class="p">.</span><span class="n">LastRentalStart</span><span class="p">,</span>
            <span class="n">t</span><span class="p">.</span><span class="n">BikeID</span><span class="p">,</span>
            <span class="n">t</span><span class="p">.</span><span class="n">Battery</span><span class="p">,</span>
            <span class="n">t</span><span class="p">.</span><span class="n">LastGPSTime</span><span class="p">,</span>
            <span class="k">CASE</span>
				<span class="k">WHEN</span> <span class="n">t</span><span class="p">.</span><span class="n">RN_RentalStart</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">THEN</span> <span class="mi">1</span>
				<span class="k">ELSE</span> <span class="mi">0</span>
			<span class="k">END</span> <span class="k">AS</span> <span class="n">RentStarting</span>
		<span class="k">FROM</span>
			<span class="p">(</span><span class="k">SELECT</span>
				<span class="n">LastRentalStart</span><span class="p">,</span> <span class="n">BikeID</span><span class="p">,</span> <span class="n">Battery</span><span class="p">,</span> <span class="n">LastGPSTime</span><span class="p">,</span>
				<span class="n">ROW_NUMBER</span><span class="p">()</span> <span class="n">OVER</span><span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">LastRentalStart</span><span class="p">,</span> <span class="n">BikeID</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">LastGPSTime</span><span class="p">)</span> <span class="k">AS</span> <span class="n">RN_RentalStart</span><span class="p">,</span>
				<span class="n">ROW_NUMBER</span><span class="p">()</span> <span class="n">OVER</span><span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">LastRentalStart</span><span class="p">,</span> <span class="n">BikeID</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">LastGPSTime</span> <span class="k">DESC</span><span class="p">)</span> <span class="k">AS</span> <span class="n">RN_RentalFinished</span>
			<span class="k">FROM</span>
				<span class="n">mobybikes</span><span class="p">.</span><span class="n">rawRentals</span>
			<span class="k">WHERE</span>
				<span class="p">(</span><span class="n">LastRentalStart</span><span class="p">,</span><span class="n">BikeID</span><span class="p">)</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">LastRentalStart</span><span class="p">,</span><span class="n">BikeID</span> <span class="k">FROM</span> <span class="n">mobybikes</span><span class="p">.</span><span class="n">TEMP_completed_rentals</span><span class="p">)</span> <span class="c1">-- get only finished rentals from temp table</span>
			<span class="k">ORDER</span> <span class="k">BY</span>
				<span class="n">BikeID</span><span class="p">,</span><span class="n">LastRentalStart</span> <span class="k">ASC</span><span class="p">)</span> <span class="n">t</span>
		<span class="k">WHERE</span>
			<span class="n">t</span><span class="p">.</span><span class="n">RN_RentalStart</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">OR</span> <span class="n">t</span><span class="p">.</span><span class="n">RN_RentalFinished</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="p">)</span>
    <span class="k">SELECT</span>
		<span class="n">LastRentalStart</span><span class="p">,</span>
        <span class="n">BikeID</span><span class="p">,</span>
        <span class="n">FLOOR</span> <span class="p">(</span><span class="k">CAST</span><span class="p">(</span> <span class="n">GROUP_CONCAT</span><span class="p">(</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">RentStarting</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">THEN</span> <span class="n">Battery</span> <span class="k">ELSE</span> <span class="k">NULL</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span> <span class="k">AS</span> <span class="n">BatteryStart</span><span class="p">,</span>
        <span class="n">FLOOR</span> <span class="p">(</span><span class="k">CAST</span><span class="p">(</span> <span class="n">GROUP_CONCAT</span><span class="p">(</span> <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">RentStarting</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">THEN</span> <span class="n">Battery</span> <span class="k">ELSE</span> <span class="k">NULL</span> <span class="k">END</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span> <span class="k">AS</span> <span class="n">BatteryEnd</span><span class="p">,</span>
        <span class="c1">-- ORDER BY RentStarting ASC so the first row to calculate would be with RentStarting = 0 (finished rental row)</span>
        <span class="c1">-- Not using IF because some rows have only one and then if there is only row with RentStarting=1, it will use that one</span>
        <span class="n">FLOOR</span> <span class="p">(</span><span class="k">CAST</span><span class="p">(</span> <span class="n">GROUP_CONCAT</span><span class="p">(</span> <span class="n">FN_RENTAL_DURATION</span><span class="p">(</span><span class="n">LastGPSTime</span><span class="p">,</span><span class="n">LastRentalStart</span><span class="p">)</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">RentStarting</span> <span class="k">ASC</span> <span class="p">)</span> <span class="k">AS</span> <span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span> <span class="k">AS</span> <span class="n">duration</span>
    <span class="k">FROM</span>
		<span class="n">CTE_RENTAL_START_FINISH</span>
	<span class="k">GROUP</span> <span class="k">BY</span>
		<span class="n">LastRentalStart</span><span class="p">,</span> <span class="n">BikeID</span>
	<span class="k">ORDER</span> <span class="k">BY</span>
		<span class="n">BikeID</span><span class="p">,</span> <span class="n">LastRentalStart</span> <span class="k">ASC</span><span class="p">;</span>

	<span class="k">CALL</span> <span class="n">SP_COORDINATES</span><span class="p">();</span>

	<span class="c1">-- returns the total of opened rentals (not to be processed yet)</span>
    <span class="k">CALL</span> <span class="n">SP_GET_TOTAL_OPENED_RENTALS</span><span class="p">(</span><span class="n">total_opened_rentals</span><span class="p">);</span>
    <span class="k">CALL</span> <span class="n">SP_CLEASING_PROCESSED_RENTALS</span><span class="p">();</span>

    <span class="c1">-- Get rentals that are left to process (it should be only opened rentals)</span>
    <span class="k">CALL</span> <span class="n">SP_GET_TOTAL_RENTALS_TO_PROCESS</span><span class="p">(</span><span class="n">rentals_to_process</span><span class="p">);</span>

    <span class="c1">-- if = 0 there is no error</span>
    <span class="c1">-- if &gt; 0 there are some rentals left which weren't processed</span>
    <span class="k">SET</span> <span class="n">number_errors</span> <span class="p">:</span><span class="o">=</span> <span class="n">rentals_to_process</span> <span class="o">-</span> <span class="n">total_opened_rentals</span><span class="p">;</span>

    <span class="c1">-- log the number of processed rentals and the number of errors occurred when processing them</span>
    <span class="k">CALL</span> <span class="n">SP_LOG_RENTAL_EVENTS</span><span class="p">(</span><span class="n">total_completed_rentals</span><span class="p">,</span> <span class="n">number_errors</span><span class="p">);</span>

<span class="k">END</span> <span class="o">//</span>
<span class="k">DELIMITER</span> <span class="p">;</span>


<span class="c1">-- --------------------------------------------------------------------------------------------------</span>
<span class="c1">-- WEATHER LOG</span>
<span class="c1">-- --------------------------------------------------------------------------------------------------</span>
<span class="n">USE</span> <span class="n">mobybikes</span><span class="p">;</span>
<span class="k">DROP</span> <span class="k">PROCEDURE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">SP_LOG_WEATHER_EVENTS</span><span class="p">;</span>
<span class="k">DELIMITER</span> <span class="o">//</span>
<span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="n">SP_LOG_WEATHER_EVENTS</span><span class="p">(</span><span class="k">IN</span> <span class="n">DATE_FILE</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="k">BEGIN</span>
    <span class="k">DECLARE</span> <span class="n">weather_events</span><span class="p">,</span> <span class="n">number_errors</span> <span class="nb">INT</span><span class="p">;</span>

    <span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">INTO</span> <span class="n">weather_events</span> <span class="k">FROM</span> <span class="n">mobybikes</span><span class="p">.</span><span class="n">Weather</span> <span class="k">WHERE</span> <span class="nb">DATE</span><span class="p">(</span><span class="nv">`Date`</span><span class="p">)</span> <span class="o">=</span> <span class="n">STR_TO_DATE</span><span class="p">(</span><span class="n">DATE_FILE</span><span class="p">,</span><span class="s1">'%Y-%m-%d'</span><span class="p">);</span>

	<span class="k">SET</span> <span class="n">number_errors</span> <span class="p">:</span><span class="o">=</span> <span class="mi">24</span> <span class="o">-</span> <span class="n">weather_events</span><span class="p">;</span> <span class="c1">-- it should have been recorded 24 hours</span>

	<span class="k">INSERT</span> <span class="k">IGNORE</span> <span class="k">INTO</span> <span class="n">mobybikes</span><span class="p">.</span><span class="n">Log_Weather</span> <span class="p">(</span><span class="nv">`Date`</span><span class="p">,</span> <span class="nv">`Processed`</span><span class="p">,</span> <span class="nv">`Errors`</span><span class="p">)</span>
    <span class="k">VALUES</span> <span class="p">(</span><span class="n">STR_TO_DATE</span><span class="p">(</span><span class="n">DATE_FILE</span><span class="p">,</span><span class="s1">'%Y-%m-%d'</span><span class="p">),</span> <span class="n">weather_events</span><span class="p">,</span> <span class="n">number_errors</span><span class="p">);</span>

<span class="k">END</span> <span class="o">//</span>
<span class="k">DELIMITER</span> <span class="p">;</span>

</code></pre></div></div>

<h2 id="schema-mysql-script">Schema MySQL Script</h2>

<p>SQL script for creating database schema.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">mobybikes</span><span class="p">;</span>

<span class="c1">-- ALTER TABLE mobybikes.Rentals_Coordinates DROP CONSTRAINT fk_Rental_Date_BikeID;</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">mobybikes</span><span class="p">.</span><span class="nv">`Rentals`</span><span class="p">;</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">mobybikes</span><span class="p">.</span><span class="nv">`Rentals_Coordinates`</span><span class="p">;</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">mobybikes</span><span class="p">.</span><span class="nv">`Weather`</span><span class="p">;</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">mobybikes</span><span class="p">.</span><span class="nv">`Day_Info`</span><span class="p">;</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">mobybikes</span><span class="p">.</span><span class="nv">`rawRentals`</span><span class="p">;</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">mobybikes</span><span class="p">.</span><span class="nv">`Log_Rentals`</span><span class="p">;</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">mobybikes</span><span class="p">.</span><span class="nv">`Log_Weather`</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">mobybikes</span><span class="p">.</span><span class="nv">`Rentals`</span> <span class="p">(</span>
	<span class="nv">`_id`</span> <span class="nb">INT</span> <span class="n">AUTO_INCREMENT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
  <span class="nv">`Date`</span> <span class="nb">datetime</span>  <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
  <span class="c1">-- Unique bike ID used for rent bike</span>
  <span class="nv">`BikeID`</span> <span class="nb">int</span>  <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
  <span class="c1">-- Battery status when rental started</span>
  <span class="nv">`BatteryStart`</span> <span class="nb">int</span> <span class="nb">signed</span>  <span class="k">default</span> <span class="k">null</span> <span class="p">,</span>
  <span class="c1">-- Battery status when rental finished</span>
  <span class="nv">`BatteryEnd`</span> <span class="nb">int</span> <span class="nb">signed</span>  <span class="k">default</span> <span class="k">null</span> <span class="p">,</span>
  <span class="c1">-- Rental Duration = LastGPSTime - LastRentalStart</span>
  <span class="nv">`Duration`</span> <span class="nb">BIGINT</span> <span class="k">NULL</span> <span class="p">,</span>
  <span class="k">CONSTRAINT</span> <span class="n">rental</span> <span class="k">UNIQUE</span> <span class="p">(</span><span class="nv">`Date`</span><span class="p">,</span><span class="nv">`BikeID`</span><span class="p">)</span>
<span class="p">);</span>

<span class="c1">-- Rentals coordinates</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">mobybikes</span><span class="p">.</span><span class="nv">`Rentals_Coordinates`</span> <span class="p">(</span>
	<span class="nv">`_id`</span> <span class="nb">INT</span> <span class="n">AUTO_INCREMENT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
	<span class="nv">`Date`</span> <span class="nb">datetime</span>  <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
	<span class="c1">-- Unique bike ID used for rent bike</span>
	<span class="nv">`BikeID`</span> <span class="nb">int</span>  <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
	<span class="c1">-- Bike coordinates if bike is locked out of station</span>
	<span class="nv">`Latitude`</span> <span class="nb">decimal</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>  <span class="k">NULL</span> <span class="p">,</span>
	<span class="c1">-- Bike coordinates if bike is locked out of station</span>
	<span class="nv">`Longitude`</span> <span class="nb">decimal</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>  <span class="k">NULL</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">mobybikes</span><span class="p">.</span><span class="nv">`Weather`</span> <span class="p">(</span>
	<span class="nv">`_id`</span> <span class="nb">INT</span> <span class="n">AUTO_INCREMENT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
  <span class="nv">`Date`</span> <span class="nb">date</span>  <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
  <span class="nv">`Hour`</span> <span class="nb">int</span>  <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
  <span class="c1">-- Morning (from 7am to noon)</span>
  <span class="c1">-- Afternoon (from midday to 6pm)</span>
  <span class="c1">-- Evening (from 6pm to 10pm)</span>
  <span class="c1">-- Night (from 10pm to 5am)</span>
  <span class="nv">`TimeOfDay`</span> <span class="nb">ENUM</span><span class="p">(</span><span class="nv">"Morning"</span><span class="p">,</span><span class="nv">"Afternoon"</span><span class="p">,</span><span class="nv">"Evening"</span><span class="p">,</span><span class="nv">"Night"</span><span class="p">)</span>  <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
  <span class="c1">-- in Celsius</span>
  <span class="nv">`Temperature`</span> <span class="nb">double</span>  <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
  <span class="c1">-- in Knots (kt)</span>
  <span class="nv">`WindSpeed`</span> <span class="nb">INT</span>  <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
  <span class="c1">-- Relative humidity (%)</span>
  <span class="nv">`Humidity`</span> <span class="nb">int</span>  <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
  <span class="c1">-- in millimetres (mm)</span>
  <span class="nv">`Rain`</span> <span class="nb">double</span>  <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
  <span class="c1">-- no rain = 0</span>
  <span class="c1">-- drizzle - 0.1~0.3</span>
  <span class="c1">-- light rain - 0.3~0.5</span>
  <span class="c1">-- moderate rain -  0.5~4</span>
  <span class="c1">-- heavy rain - &gt;4</span>
  <span class="nv">`RainLevel`</span> <span class="nb">ENUM</span><span class="p">(</span><span class="nv">"no rain"</span><span class="p">,</span><span class="nv">"drizzle"</span><span class="p">,</span><span class="nv">"light rain"</span><span class="p">,</span><span class="nv">"moderate rain"</span><span class="p">,</span><span class="nv">"heavy rain"</span><span class="p">)</span>  <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">);</span>

<span class="c1">-- Date and time features</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">mobybikes</span><span class="p">.</span><span class="nv">`Day_Info`</span> <span class="p">(</span>
	<span class="nv">`_id`</span> <span class="nb">INT</span> <span class="n">AUTO_INCREMENT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="nv">`Date`</span> <span class="nb">date</span>  <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
    <span class="c1">-- Monday = 0 ~ Sunday = 6</span>
    <span class="nv">`DayofWeek`</span> <span class="nb">tinyint</span> <span class="nb">UNSIGNED</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
    <span class="c1">-- Irish National Bank Holidays</span>
    <span class="nv">`Holiday`</span> <span class="nb">boolean</span>  <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
    <span class="c1">-- Monday to Friday AND not Bank Holiday</span>
    <span class="nv">`WorkingDay`</span> <span class="nb">boolean</span>  <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
    <span class="c1">-- Spring | Summer | Autumn | Winter</span>
    <span class="nv">`Season`</span> <span class="nb">ENUM</span><span class="p">(</span><span class="nv">"Spring"</span><span class="p">,</span><span class="nv">"Summer"</span><span class="p">,</span><span class="nv">"Autumn"</span><span class="p">,</span><span class="nv">"Winter"</span><span class="p">)</span>  <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">);</span>

<span class="c1">-- Table with all rentals before preprocess</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">mobybikes</span><span class="p">.</span><span class="nv">`rawRentals`</span> <span class="p">(</span>
	<span class="nv">`_id`</span> <span class="nb">INT</span> <span class="n">AUTO_INCREMENT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="c1">-- Last time bike was rented</span>
    <span class="nv">`LastRentalStart`</span> <span class="nb">datetime</span>  <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
    <span class="c1">-- Use for rent bike</span>
    <span class="nv">`BikeID`</span> <span class="nb">int</span>  <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
    <span class="c1">-- Bike max distance in km</span>
    <span class="nv">`Battery`</span> <span class="nb">int</span> <span class="nb">signed</span>  <span class="k">default</span> <span class="k">null</span> <span class="p">,</span>
    <span class="c1">-- Last time bike connected with GPS</span>
    <span class="nv">`LastGPSTime`</span> <span class="nb">datetime</span>  <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
    <span class="c1">-- Bike coordinates if bike is locked out of station</span>
    <span class="nv">`Latitude`</span> <span class="nb">decimal</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>  <span class="k">NULL</span> <span class="p">,</span>
    <span class="c1">-- Bike coordinates if bike is locked out of station</span>
    <span class="nv">`Longitude`</span> <span class="nb">decimal</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>  <span class="k">NULL</span><span class="p">,</span>
    <span class="k">CONSTRAINT</span> <span class="n">gps_rental</span> <span class="k">UNIQUE</span><span class="p">(</span><span class="nv">`LastRentalStart`</span><span class="p">,</span><span class="nv">`BikeID`</span><span class="p">,</span> <span class="nv">`LastGPSTime`</span><span class="p">)</span>
<span class="p">);</span>

<span class="c1">-- Log events to track processing errors on Rentals</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">mobybikes</span><span class="p">.</span><span class="nv">`Log_Rentals`</span> <span class="p">(</span>
	<span class="nv">`_id`</span> <span class="nb">INT</span> <span class="n">AUTO_INCREMENT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="nv">`Date`</span> <span class="nb">DATETIME</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
    <span class="c1">-- Total Rentals processed</span>
    <span class="nv">`Processed`</span> <span class="nb">int</span> <span class="k">NULL</span> <span class="p">,</span>
    <span class="c1">-- Number of Rentals failed to be processed</span>
    <span class="nv">`Errors`</span> <span class="nb">int</span> <span class="k">NULL</span>
<span class="p">);</span>

<span class="c1">-- Log events to track processing errors on Weather Data</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">mobybikes</span><span class="p">.</span><span class="nv">`Log_Weather`</span> <span class="p">(</span>
	<span class="nv">`_id`</span> <span class="nb">INT</span> <span class="n">AUTO_INCREMENT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="nv">`Date`</span> <span class="nb">DATE</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
    <span class="c1">-- Weather data processed</span>
    <span class="nv">`Processed`</span> <span class="nb">int</span> <span class="k">NULL</span> <span class="p">,</span>
    <span class="c1">-- Number of hourly weather data failed to be processed</span>
    <span class="nv">`Errors`</span> <span class="nb">int</span> <span class="k">NULL</span>
<span class="p">);</span>

<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">mobybikes</span><span class="p">.</span><span class="nv">`Rentals_Coordinates`</span> <span class="k">ADD</span> <span class="k">CONSTRAINT</span> <span class="nv">`fk_Rental_Date_BikeID`</span> <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="nv">`Date`</span><span class="p">,</span> <span class="nv">`BikeID`</span><span class="p">)</span>
<span class="k">REFERENCES</span> <span class="n">mobybikes</span><span class="p">.</span><span class="nv">`Rentals`</span><span class="p">(</span><span class="nv">`Date`</span><span class="p">,</span> <span class="nv">`BikeID`</span><span class="p">);</span>

</code></pre></div></div>

			</article>

			<!-- <div style='position: relative; padding: 10px;height: 100px; line-height: 100px; text-align: center;'>
				<img title="GitHub Mark" src="https://github.com/pessini/avian-flu-wild-birds-ireland/blob/main/img/GitHub-Mark-64px.png?raw=true"
				style="height: 18px;" alt="GitHub Mark">
				<a href='https://github.com/pessini/moby-bikes'
				target='_blank'
				style="font-size: small;display: inline-block;
  							vertical-align: middle;
  							line-height: normal;margin-bottom:5px;">GitHub Repository</a>
			</div> -->
			<div>
				<p align="center">
				  <a href="https://github.com/pessini"><img alt="GitHub" title="GitHub" height="18" width="18" src="/moby-bikes/images/github.svg"></a>
					<span style="font-size: 18px; display: inline-block;">|</span>
				  <a href="https://www.linkedin.com/in/leandropessini"><img alt="LinkedIn" title="LinkedIn" height="18" width="18" src="/moby-bikes/images/linkedin.svg"></a>
					<br />Project by <a href="https://pessini.me">Leandro Pessini</a>
				</p>
			</div>
			<div style="padding-bottom: 1px;"></div>
		</section>

		<script>
			document.getElementById("open-nav").addEventListener("click", function () {
				document.body.classList.toggle("nav-open");
			});
		</script>
		<!-- Back To Top button https://github.com/vfeskov/vanilla-back-to-top -->
		<script src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
		<script>addBackToTop({
		  diameter: 56,
		  backgroundColor: '#206b82',
		  textColor: '#fff'
		})</script>
	</body>
</html>
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
